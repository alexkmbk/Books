@model IEnumerable<Books.Models.Publisher>

<h1>@Html.ViewData["Title"]</h1>

<div id="publishers_panel">
    @*Командная панель с кнопками управления таблицей*@
    <input name="AddButton" type="button" value="Добавить" autofocus class="btn btn-default" />
    <input name="EditButton" type="button" value="Изменить" class="btn btn-default" />
    <input name="DeleteButton" type="button" value="Удалить" class="btn btn-default" />
</div>

@*Таблица с контрагентами*@
<div id="publishers_table_div" class="group_col table-container">
    @Html.Partial("_Table", Model)
</div>

<div id="publishers_divmsg"></div>

<script>

     var saving;

     var cols = [new Column({ name: "Id", isVisible: false }),
                 new Column({ name: "Name", isVisible: true })];

        var publishers_table = new Table("publishers_table", true, cols, $(window), cols[0]);

        var panel = $("#publishers_panel");
        panel.find("input[name='AddButton']").get(0).onclick = publishers_table.Add;
        panel.find("input[name='EditButton']").get(0).onclick = publishers_table.Edit;
        panel.find("input[name='DeleteButton']").get(0).onclick = publishers_table.BeforeDelete;

        //Удалить запись
        window.addEventListener("publishers_table_BeforeDelete", function (e) {

            var rowdata = e.detail;
            $.ajax({
                type: 'POST',
                url: 'Publishers/Delete',
                data: { Id: rowdata['Id'] },
                success: function (data) {
                    if (data["isOk"]) {
                        publishers_table.Delete(); // удалить строку в диалоге
                    }
                    else {
                        var myDiv = document.getElementById("publishers_divmsg");
                        myDiv.innerHTML = "Ошибка записи: " + data["Errors"];
                    }
                },
                error: function (xhr, str) {
                    var myDiv = document.getElementById("publishers_divmsg");
                    myDiv.innerHTML = "Ошибка записи: " + xhr.responseText;
                }
            });
        });

        window.addEventListener("publishers_table_SaveTable", function (e) {

                var action;
                var rowdata;

                if (saving) return;

                saving = true;

                if (e.detail["Id"] == "") {
                     action = 'Publishers/Create';
                    rowdata = { Name: e.detail["Name"]}
                }
                else {
                    action = 'Publishers/Update';
                    rowdata = { Name: e.detail["Name"], Id: e.detail["Id"] }
                }
                $.ajax({
                    type: 'POST',
                    url: action,
                    data: rowdata,
                    success: function (data) {
                        if (data["isOk"]) {
                            publishers_table.EndEditing(data["Id"]);
                            saving = false;
                        }
                        else {
                            var myDiv = document.getElementById("publishers_divmsg");
                            myDiv.innerHTML = "Ошибка записи: " + data["Errors"];
                            saving = false;
                        }
                    },
                    error: function (xhr, str) {
                        var myDiv = document.getElementById("publishers_divmsg");
                        myDiv.innerHTML = "Ошибка записи: " + xhr.responseText;
                        saving = false;
                    }
                });
            });


</script>
